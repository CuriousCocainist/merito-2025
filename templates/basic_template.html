{% load static %}
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="stylesheet" type="text/css" href="{% static 'css/tailwind.css' %}">
    <title>SCInet</title>
</head>
<body class="bg-white">
<!-- Pasek nawigacyjny -->
{% include 'nav.html' %}

<form style="display: none;">
    {% csrf_token %}
</form>

<main class="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 gap-6 {% if is_grid_cols_1 %}grid-cols-1{% else %}grid-cols-1 lg:grid-cols-3{% endif %}">
    {% block content %}{% endblock %}
    <aside class="space-y-6">
    {% block sidebar %}
    {% endblock %}
    </aside>
</main>
{% include 'footer.html' %}

{% for message in messages %}
    {% if message and message.tags and message.message and message.message|length > 0 %}
        <div id="message-popup" class="fixed inset-0 flex items-center justify-center z-50">
            <div class="bg-blue-50 border border-blue-400 text-blue-800 px-6 py-4 rounded shadow-md text-center max-w-md">
                <p>{{ message }}</p>
            </div>
        </div>
        <script>
            setTimeout(() => {
                const popup = document.getElementById('message-popup');
                if (popup) popup.style.display = 'none';
            }, 3000);
        </script>
    {% endif %}
{% endfor %}


<script>
    document.addEventListener('DOMContentLoaded', function () {
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        const csrfToken = csrfTokenElement ? csrfTokenElement.value : ''; // pobiera token CSRF

        // ObsÅ‚uga przycisku "Polub"
        document.querySelectorAll('.like-toggle').forEach(button => {
            button.addEventListener('click', function () {
                const articleId = this.dataset.articleId; // id artykuÅ‚u
                const liked = this.dataset.liked === 'true'; // sprawdÅº, czy uÅ¼ytkownik juÅ¼ polubiÅ‚
                const url = liked ? `/unlike/${articleId}/` : `/like/${articleId}/`; // wybierz odpowiedni URL

                // WyÅ›lij Å¼Ä…danie do serwera (like/unlike)
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken':  csrfToken, // dodaj token bezpieczeÅ„stwa
                        'Accept': 'application/json',
                    },
                })
                    .then(response => response.json())
                    .then(data => {
                        this.dataset.liked = data.liked.toString(); // Zaktualizuj atrybuty HTML: czy artykuÅ‚ jest polubiony
                        this.querySelector('.like-label').textContent = data.liked ? 'Lubisz to' : 'Polub'; // zmienia tekst

                    //  aktualizacja liczby polubieÅ„ i wyglÄ…du ikony serca
                    const likeInfo = this.parentElement.querySelector('.like-info');
                    if (likeInfo) {
                        const countSpan = likeInfo.querySelector('.like-count');
                        if (countSpan) {
                            countSpan.textContent = data.like_count;
                        }

                    // Zmienia kolor wypeÅ‚nienia ikony serca
                        const heartIcon = likeInfo.querySelector('.heart-icon');
                        if (heartIcon) {
                            if (data.liked) {
                                // JeÅ›li polubione â€“ pokoloruj na czerwono
                                heartIcon.setAttribute('fill', 'red');
                                heartIcon.setAttribute('stroke', 'red');
                            } else {
                                // JeÅ›li niepolubione â€“ usuÅ„ kolor
                                heartIcon.setAttribute('fill', 'none');
                                heartIcon.setAttribute('stroke', 'currentColor');
                            }
                        }
                    }
                });
            });
        });

        // ObsÅ‚uga przycisku "Obserwuj"
        document.querySelectorAll('.follow-toggle').forEach(function (button) {
            button.addEventListener('click', function () {
                const articleId = this.dataset.articleId; // id artykuÅ‚u
                const followed = this.dataset.followed === 'true'; // czy juÅ¼ obserwowany
                const url = followed ? this.dataset.unfollowUrl : this.dataset.followUrl; // wybierz odpowiedni URL
                const label = this.querySelector(".follow-label");  // tekst przy dzwonku
                const icon = this.querySelector("svg"); // ikona dzwonka

                // WyÅ›lij Å¼Ä…danie (obserwuj/nie obserwuj)
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        'article_id': articleId // dane wysyÅ‚ane do serwera
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    this.dataset.followed = data.followed.toString(); // aktualizuj dane w HTML

                    // ZmieÅ„ kolor ikony dzwonka w zaleÅ¼noÅ›ci od stanu
                    if (icon) {
                        if (data.followed) {
                            icon.setAttribute('stroke', '#FFD700'); // Å¼Ã³Å‚ty, jeÅ›li obserwowany
                            icon.setAttribute('fill', '#FFD700');
                        } else {
                            icon.setAttribute('stroke', 'currentColor'); // domyÅ›lny (pusty), jeÅ›li nie
                            icon.setAttribute('fill', 'none');
                        }
                    }
                    // ZmieÅ„ tekst "Obserwuj" â†” "Nie obserwuj" i ewentualne usuniÄ™cie artykuÅ‚u z listy
                    if (label) {
                        label.textContent = data.followed ? 'Nie obserwuj' : 'Obserwuj';

                        // JeÅ›li jesteÅ›my na liÅ›cie obserwowanych i uÅ¼ytkownik kliknie "Nie obserwuj"
                        const articleCard = button.closest('.article-card');
                        if (articleCard) {
                            articleCard.remove(); // usuÅ„ artykuÅ‚ z widoku

                            // JeÅ›li nie ma wiÄ™cej artykuÅ‚Ã³w, pokaÅ¼ komunikat
                            const remainingCards = document.querySelectorAll('.article-card');
                            if (remainingCards.length === 0) {
                                const section = document.querySelector('section.lg\\:col-span-2');
                                if (section) {
                                    const emptyMessage = document.createElement('p');
                                    emptyMessage.textContent = 'Nie obserwujesz Å¼adnego artykuÅ‚u. Kliknij obserwuj ðŸ”” na wybranym artykule, aby go tutaj zobaczyÄ‡.';
                                    emptyMessage.classList.add('mt-4', 'text-gray-600'); // opcjonalne style
                                    section.appendChild(emptyMessage);
                                }
                            }
                        }
                    }


                });
            });
        });
    });


    function showToast(message, type = 'success') {
        const toast = document.createElement('div');
        toast.innerText = message;
        toast.className = `fixed top-4 right-4 z-50 px-4 py-2 rounded-md shadow-lg text-white text-sm font-semibold ${
            type === 'success' ? 'bg-green-600' : 'bg-red-600'
        }`;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }
</script>


{% block script %}{% endblock %}

</body>
</html>